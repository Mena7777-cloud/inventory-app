import streamlit as st
import json
import os

# --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ---
FILE_PATH = 'inventory_v2.json'

# --- Ø¯ÙˆØ§Ù„ Ø­ÙØ¸ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
def load_data():
    if os.path.exists(FILE_PATH):
        try:
            with open(FILE_PATH, 'r', encoding='utf-8') as f:
                return json.load(f)
        except json.JSONDecodeError:
            return []
    return []

def save_data(data):
    with open(FILE_PATH, 'w', encoding='utf-8') as f:
        json.dump(data, f, indent=4, ensure_ascii=False)

# --- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
if 'inventory' not in st.session_state:
    st.session_state.inventory = load_data()

# --- ØªØµÙ…ÙŠÙ… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
st.set_page_config(layout="wide", page_title="Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† v2.1")
st.title("Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø­Ø³Ù‘Ù†)")
st.write("---")

# --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ---
menu_choice = st.sidebar.selectbox("Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©", ["Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†", "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬", "Ø¨Ø­Ø« ÙˆØªØ¹Ø¯ÙŠÙ„"])

# --- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ---
if menu_choice == "Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†":
    st.subheader("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†")
    if st.session_state.inventory:
        # Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø³Ø¹Ø±
        display_list = []
        for item in st.session_state.inventory:
            formatted_item = {
                "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬": item["name"],
                "Ø§Ù„ÙƒÙ…ÙŠØ©": item["quantity"],
                "Ø§Ù„Ø³Ø¹Ø±": f"{item['price']:.2f}"
            }
            display_list.append(formatted_item)
        st.table(display_list)
    else:
        st.info("Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙØ§Ø±Øº Ø­Ø§Ù„ÙŠØ§Ù‹.")

# --- Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ ---
elif menu_choice == "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬":
    st.subheader("Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯")
    with st.form(key="add_form", clear_on_submit=True):
        name = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬")
        quantity = st.number_input("Ø§Ù„ÙƒÙ…ÙŠØ©", min_value=0, step=1)
        price = st.number_input("Ø§Ù„Ø³Ø¹Ø±", min_value=0.0, format="%.2f")
        
        if st.form_submit_button("âœ¨ Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†"):
            if name:
                new_product = {"name": name, "quantity": int(quantity), "price": float(price)}
                st.session_state.inventory.append(new_product)
                save_data(st.session_state.inventory)
                st.success(f"ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© '{name}' Ø¨Ù†Ø¬Ø§Ø­!")
                st.rerun()
            else:
                st.error("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬.")

# --- Ø¨Ø­Ø« ÙˆØªØ¹Ø¯ÙŠÙ„ ---
elif menu_choice == "Ø¨Ø­Ø« ÙˆØªØ¹Ø¯ÙŠÙ„":
    st.subheader("Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ ÙˆØªØ¹Ø¯ÙŠÙ„Ù‡ Ø£Ùˆ Ø­Ø°ÙÙ‡")
    search_term = st.text_input("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø¨Ø­Ø«...")

    if search_term:
        results = [p for p in st.session_state.inventory if search_term.lower() in p['name'].lower()]
        
        if not results:
            st.warning("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù….")
        else:
            for product in results:
                st.markdown(f"### ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬: {product['name']}")
                
                # Ù†Ø³ØªØ®Ø¯Ù… ÙÙ‡Ø±Ø³ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„ØªØ­Ø¯ÙŠØ«Ù‡
                original_index = st.session_state.inventory.index(product)

                with st.form(key=f"edit_{original_index}"):
                    new_name = st.text_input("Ø§Ù„Ø§Ø³Ù…", value=product['name'])
                    new_quantity = st.number_input("Ø§Ù„ÙƒÙ…ÙŠØ©", value=product['quantity'], min_value=0, step=1)
                    new_price = st.number_input("Ø§Ù„Ø³Ø¹Ø±", value=product['price'], min_value=0.0, format="%.2f")
                    
                    col1, col2 = st.columns(2)
                    with col1:
                        if st.form_submit_button("ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"):
                            updated_product = {"name": new_name, "quantity": int(new_quantity), "price": float(new_price)}
                            st.session_state.inventory[original_index] = updated_product
                            save_data(st.session_state.inventory)
                            st.success("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­!")
                            st.rerun()
